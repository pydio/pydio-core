<?xml version="1.0" encoding="UTF-8"?>
<driver name="fs" className="class.fsDriver.php">
	<actions>
		<action name="ls" dirDefault="true">			
			<gui text="32" title="32" src="fileopen.png"
				accessKey="folder_access_key">
				<context selection="true" dir="" recycle="false"
					actionBar="false" actionBarGroup="get" contextMenu="true" infoPanel="false">
				</context>
				<selectionContext dir="true" file="false" recycle="false"
					unique="true" allowedMimes="*">
				</selectionContext>
			</gui>
			<rightsContext noUser="true" userLogged="only" read="true"
				write="false" adminOnly="false">
			</rightsContext>
			<processing>
				<clientCallback prepareModal="true"><![CDATA[
					var path;					
					if(window.actionArguments && window.actionArguments.length>0){
						path = window.actionArguments[0];
						if(Object.isString(path)){path = new AjxpNode(path,false,getBaseName(path));}
					}else{
						userSelection = ajaxplorer.getUserSelection();
						if(userSelection && userSelection.isUnique() && (userSelection.hasDir() || userSelection.hasMime(["zip"]))){
							path = userSelection.getUniqueNode();
						}
					}
					if(path){
						ajaxplorer.updateContextData(path);
					}						
					]]></clientCallback>
				<serverCallback methodName="switchAction"></serverCallback>
			</processing>
		</action>
		<action name="create_user">
			<gui text="297" title="298" src="yast_user_add.png" accessKey="create_user_accesskey" hasAccessKey="true">
				<context selection="false" dir="false" recycle="hidden"  behaviour="hidden"
					actionBar="true" contextMenu="false" infoPanel="false"
					actionBarGroup="put" inZip="false">
				</context>
			</gui>
			<rightsContext noUser="true" userLogged="only" read="true" write="true" adminOnly="true"></rightsContext>
			<processing>
				<clientCallback prepareModal="true"><![CDATA[
					var completeFunc = function(){
						var oForm = modal.getForm();
						if(!ajaxplorer.actionBar.configEditor){
							ajaxplorer.actionBar.configEditor = new ConfigEditor(oForm);
						}
						ajaxplorer.actionBar.configEditor.setForm(oForm);
						ajaxplorer.actionBar.configEditor.submitCreateUser();
						hideLightBox();
						return false;
					};
					modal.showDialogForm('Create User', 'create_user_box', null, completeFunc);
					]]></clientCallback>
				<clientForm id="create_user_box"><![CDATA[
					<div id="create_user_box" action="create_user" box_width="210">
						<div class="SF_element">
							<div class="SF_label" ajxp_message_id="94">AJXP_MESSAGE[94] : </div><input name="new_user_login" type="text" class="dialogFocus SF_input"/>
						</div>
						<div class="SF_element">
							<div class="SF_label" ajxp_message_id="182">AJXP_MESSAGE[182] : </div><input name="new_user_pwd" type="password" class="SF_input"/>
						</div>
						<div class="SF_element">						
							<div class="SF_label" ajxp_message_id="199">AJXP_MESSAGE[199] : </div><input name="new_user_pwd_conf" type="password" class="SF_input"/>
						</div>
					</div>				
				]]></clientForm>
				<serverCallback methodName="switchAction"></serverCallback>
				</processing>
		</action>	
		<action name="create_repository">
			<gui text="299" title="300" src="folder_red_new.png" accessKey="create_repo_accesskey" hasAccessKey="true">
				<context selection="false" dir="false" recycle="hidden"  behaviour="hidden"
					actionBar="true" contextMenu="false" infoPanel="false"
					actionBarGroup="put" inZip="false">
				</context>
			</gui>
			<rightsContext noUser="true" userLogged="only" read="true" write="true" adminOnly="true"></rightsContext>
			<processing>
				<clientCallback prepareModal="true"><![CDATA[
					var loadFunc = function(oForm){
						ajaxplorer.getUserSelection().updateFormOrUrl(oForm);
						if(!ajaxplorer.actionBar.configEditor){
							ajaxplorer.actionBar.configEditor = new ConfigEditor(oForm);
						}
						ajaxplorer.actionBar.configEditor.setForm(oForm);
						ajaxplorer.actionBar.configEditor.initCreateRepoWizard();
					};				
					modal.showDialogForm('Create Repository', 'create_repository_box', loadFunc, null, null, false, true);
					]]></clientCallback>
				<clientForm id="create_repository_box"><![CDATA[
					<div id="create_repository_box" action="create_repository" box_width="320">
						<div class="SF_element">
							<div class="SF_label">Repository Label* : </div>							
							<input name="new_user_login" type="text" class="SF_input dialogFocus"/>
						</div>
						<div class="SF_element">
							<div class="SF_label">Repository Driver* : </div>							
							<select class="SF_input"><option>Loading...</option></select>
						</div>
						<div id="driver_form"></div>
						<div class="dialogButtons">
							<input type="image" src="AJXP_THEME_FOLDER/images/actions/22/dialog_ok_apply.png" height="22" width="22" class="dialogButton" id="submit_create_repo" value="Next" class="button" onclick="return false;">
							<input type="image" src="AJXP_THEME_FOLDER/images/actions/22/dialog_close.png" height="22" width="22" class="dialogButton" value="Cancel" class="button" onclick="hideLightBox();return false;">
						</div>
					</div>				
				]]></clientForm>
				<serverCallback methodName="switchAction"></serverCallback>
				</processing>
		</action>	
		<action name="rename">
			<gui text="6" title="158" src="applix.png" accessKey="rename_access_key" hasAccessKey="true">
				<context selection="true" dir="" recycle="hidden"
					actionBar="true" contextMenu="true" infoPanel="false"
					actionBarGroup="change" inZip="false">
				</context>
				<selectionContext dir="false" file="true" recycle="false" unique="true" allowedMimes="repository_editable" behaviour="hidden"></selectionContext></gui>
			<rightsContext noUser="true" userLogged="only" read="true" write="true" adminOnly=""></rightsContext>
			<processing>
				<clientCallback prepareModal="false"><![CDATA[
					var callback = function(node, newValue){						
						var conn = new Connexion();
						conn.addParameter('get_action', 'edit');
						conn.addParameter('sub_action', 'edit_repository_label');
						conn.addParameter('repository_id', node.getMetadata().get('repository_id'));
						conn.addParameter('newLabel', newValue);
						conn.onComplete = function(transport){
							ajaxplorer.actionBar.parseXmlMessage(transport.responseXML);
						};
						conn.sendSync();
					};

					if(ajaxplorer.getUserSelection() && ajaxplorer.getUserSelection().getSelectionSource() && ajaxplorer.getUserSelection().getSelectionSource().switchCurrentLabelToEdition) {ajaxplorer.getUserSelection().getSelectionSource().switchCurrentLabelToEdition(callback);}
					]]></clientCallback>
				<serverCallback methodName="switchAction"></serverCallback>
				</processing>
		</action>						
		<action name="edit" fileDefault="true">
			<gui text="51" title="301" src="edit.png" accessKey="edit_access_key" hasAccessKey="true">
				<context selection="true" dir="" recycle="hidden"  behaviour="hidden"
					actionBar="true" contextMenu="true" infoPanel="true"
					actionBarGroup="change" inZip="false">
				</context>
				<selectionContext dir="false" file="true" recycle="false" unique="true" allowedMimes="user,user_editable,repository,repository_editable" behaviour="hidden"></selectionContext></gui>
			<rightsContext noUser="true" userLogged="only" read="true" write="true" adminOnly=""></rightsContext>
			<processing>
				<clientCallback prepareModal="true"><![CDATA[
					var userSelection =  ajaxplorer.getUserSelection();
					var node = userSelection.getUniqueNode();
					var meta = node.getMetadata();
					if(meta.get("ajxp_mime") == "user" || meta.get("ajxp_mime") == "user_editable"){
						var loadFunc = function(oForm){
							ajaxplorer.getUserSelection().updateFormOrUrl(oForm);
							if(!ajaxplorer.actionBar.configEditor){
								ajaxplorer.actionBar.configEditor = new ConfigEditor(oForm);
							}						
							ajaxplorer.actionBar.configEditor.setForm(oForm);
							ajaxplorer.actionBar.configEditor.loadUser(meta.get("text"));
						};
						modal.showDialogForm('Edit Online', 'edit_config_box', loadFunc, function(){hideLightBox();}, null, true);					
					}else{
						var loadFunc = function(oForm){
							ajaxplorer.getUserSelection().updateFormOrUrl(oForm);
							if(!ajaxplorer.actionBar.configEditor){
								ajaxplorer.actionBar.configEditor = new ConfigEditor(oForm);
							}						
							ajaxplorer.actionBar.configEditor.setForm(oForm);
							ajaxplorer.actionBar.configEditor.loadRepository(meta.get("repository_id"));
						};
						var closeFunc = function(){
							var toSubmit = new Hash();
							var configEditor = ajaxplorer.actionBar.configEditor;
							if(!configEditor.currentRepoWriteable){
								hideLightBox();
								return;
							}
							toSubmit.set("repository_id", configEditor.currentRepoId);
							configEditor.submitParametersInputs(configEditor.currentForm, toSubmit, 'DRIVER_OPTION_');
							configEditor.submitForm('edit_repository', 'edit_repository_data', toSubmit, null, function(){
								this.loadRepList();
								this.loadUsers();
							}.bind(configEditor));							
							hideLightBox();
						};
						modal.showDialogForm('Edit Online', 'edit_repo_box', loadFunc, closeFunc);
					}					
					]]></clientCallback>
				<clientForm id="edit_config_box"><![CDATA[
					<div id="edit_config_box" action="edit_user" box_width="350">
						<fieldset id="rights_pane">
							<legend>Repositories Access</legend>
							<div style="max-height:140px;overflow:auto;_height:140px;">
							<table class="repository" width="100%" cellspacing="0">
								<tbody>
								<tr id="loading_row"><td>Loading...</td></tr>
								</tbody>
							</table>
							</div>
						</fieldset>
						<fieldset id="password_pane" style="float:left;margin-right:6px;width:198px;height:70px;">
							<legend>Modify password</legend>
							<input style="float:right;margin-top:18px;" type="image" class="dialogButton" value="OK" name="new_pass_button" onclick="return false;" src="AJXP_THEME_FOLDER/images/actions/22/dialog_ok_apply.png"/>
							<div style="width:168px;">
								<div class="SF_element">
									<div class="SF_label" ajxp_message_id="182">AJXP_MESSAGE[182] :</div><input type="password" id="new_pass" class="SF_input"/>
								</div>
								<div class="SF_element">
									<div class="SF_label" ajxp_message_id="199">AJXP_MESSAGE[199] :</div><input type="password" id="new_pass_confirm"  class="SF_input"/>
								</div>
							</div>
						</fieldset>
						<fieldset id="admin_right_pane" style="height:70px;"><legend>Admin Right</legend>
						User has admin rights? <input id="admin_rights" class="user_delete_confirm" type="checkbox" style="width:20px;" />
						</fieldset>
					</div>
					<div id="edit_repo_box" action="edit_repository" box_width="320">
						<fieldset id="options_pane">
							Loading...
						</fieldset>
					</div>													
				]]></clientForm>
				<serverCallback methodName="switchAction"></serverCallback>
				</processing>
		</action>			
		<action name="edit_meta_source">
			<processing>
				<serverCallback methodName="switchAction"></serverCallback>
			</processing>
		</action>
		<action name="add_meta_source">
			<processing>
				<serverCallback methodName="switchAction"></serverCallback>
			</processing>
		</action>
		<action name="delete_meta_source">
			<processing>
				<serverCallback methodName="switchAction"></serverCallback>
			</processing>
		</action>
		<action name="delete">			
			<gui text="7" title="161" src="editdelete.png" accessKey="delete_access_key" hasAccessKey="true">
				<context selection="true" dir="" recycle="false"
					actionBar="true" contextMenu="true" infoPanel="false"
					actionBarGroup="change" inZip="false">
				</context>
				<selectionContext dir="false" file="true" recycle="false" unique="false"  allowedMimes="user_editable,repository_editable" image="false" editable="false"></selectionContext></gui>
			<rightsContext noUser="true" userLogged="only" read="true" write="true" adminOnly=""></rightsContext>
			<processing>
				<clientCallback prepareModal="true"><![CDATA[
					var userSelection =  ajaxplorer.getUserSelection();
					var node = userSelection.getUniqueNode();
					var meta = node.getMetadata();
					var deleteMessage, fieldName, fieldValue;
					if(meta.get("ajxp_mime") == "user_editable"){
						deleteMessage = "Are you sure you want to delete this user? This operation is not reversible!";
						fieldName = "user_id";
						fieldValue = meta.get("text");
					}else{
						deleteMessage = "Are you sure you want to delete this repository? This operation is not reversible!";
						fieldName = "repository_id";
						fieldValue = meta.get("repository_id");
					}
					var onLoad = function(oForm){
		   		    	$(oForm).select('span[id="delete_message"]')[0].update(deleteMessage);
		   		    	var hidden = $(oForm).select('input[type="hidden"]')[0];
		   		    	hidden.setAttribute("name", fieldName);
		   		    	hidden.setAttribute("value", fieldValue);
					};
					modal.showDialogForm('Delete', 'delete_config_form', onLoad, function(){
						var oForm = modal.getForm();						
						ajaxplorer.actionBar.submitForm(oForm);
                        if (userSelection.isMultiple()) {
                           var i = 1; 
	   		    	       var hidden = $(oForm).select('input[type="hidden"]')[0];
                           while (true) {
                              try {
                                  var node = userSelection.getNode(i);
                                  var meta = node.getMetadata();
                                  hidden.setAttribute("value", meta.get("ajxp_mime") == "user_editable" ? meta.get("text") : meta.get("repository_id"));
            					  ajaxplorer.actionBar.submitForm(oForm);
                                  i++;
                              } catch (e) 
                              {
                                  break;
                              }
                           }
                        }
						hideLightBox(true);
						return false;
					});
					]]></clientCallback>
				<clientForm id="delete_config_form"><![CDATA[
				<div id="delete_config_form" action="delete" box_width="280">
					<span id="delete_message"></span>
					<input type="hidden" name="" value=""/>
				</div>
				]]></clientForm>
				<serverCallback methodName="switchAction"></serverCallback>
				</processing>
		</action>		
		<action name="copyAsText">			
			<gui text="302" title="303" src="editcopy.png" accessKey="" hasAccessKey="false">
				<context selection="true" dir="" recycle="false"
					actionBar="true" contextMenu="true" infoPanel="false"
					actionBarGroup="change" inZip="false">
				</context>
				<selectionContext dir="false" file="true" recycle="false" unique="false" allowedMimes="log,testResult"  image="false" editable="false"></selectionContext></gui>
			<rightsContext noUser="true" userLogged="only" read="true" write="true" adminOnly=""></rightsContext>
			<processing>
				<clientCallback prepareModal="true"><![CDATA[
					var onLoad = function(oForm){
						var userSelection =  ajaxplorer.getUserSelection();
						var nodes = userSelection.getSelectedNodes();
						var firstNode = userSelection.getUniqueNode();						
		   		    	var copyDiv = $(oForm).select('textarea[id="text_copy"]')[0];
		   		    	var attributes = ['date','ip','level','user','action','params'];
			   		    var message = attributes.join("\t") + "\n\n";
		   		    	nodes.each(function(node){	
		   		    		var meta = node.getMetadata();	   		    		
		   		    		for(var i=0;i<attributes.length;i++){
		   		    			var attName = attributes[i];
		   		    			if(attName == "ajxp_label") attName = "text";
		   		    			message += meta.get(attName) + '\t';
		   		    		}
			   		    	message += '\n';
		   		    	});
		   		    	copyDiv.setValue(message);
		   		    	copyDiv.select();
					};
					modal.showDialogForm('Delete', 'copy_as_text', onLoad, function(){
						hideLightBox(true);
						return false;
					},null,true);
					]]></clientCallback>
				<clientForm id="copy_as_text"><![CDATA[
				<div id="copy_as_text" action="copy" box_width="650">
					<textarea id="text_copy" style="width:630px; height: 350px;"></textarea>
				</div>
				]]></clientForm>
				<serverCallback methodName="switchAction"></serverCallback>
				</processing>
		</action>					
					
	</actions>
	<client_configs>
		<component_config className="InfoPanel">
			<infoPanel mime="generic_file" attributes="icon,text">
				<messages>
					<message key="name_string" id="133"/>
					<message key="size_string" id="127"/>
					<message key="type_string" id="134"/>
					<message key="modif_string" id="138"/>
				</messages>
				<html><![CDATA[
				<div style="padding:10px;">
					<div class="folderImage">
						<img src="AJXP_THEME_FOLDER/images/mimes/64/#{icon}" height="64" width="64">
					</div>
					<b>#{name_string}</b> : #{text}
				</div>
				]]></html>
			</infoPanel>
			<infoPanel mime="generic_dir" attributes="icon,text">
				<messages>
					<message key="name_string" id="133"/>
					<message key="modif_string" id="138"/>
				</messages>
				<html><![CDATA[
					<div style="padding:10px;">
						<div class="folderImage">
							<img src="AJXP_THEME_FOLDER/images/mimes/64/#{icon}" height="64" width="64">
						</div>
						<b>#{name_string}</b> : #{text}
					</div>
				]]></html>
			</infoPanel>
			<infoPanel mime="no_selection" attributes="">
				<messages>
					<message key="files_string" id="265"/>
				</messages>
				<html><![CDATA[
					<div style="padding:10px;">
						<div class="folderImage">
							<img src="AJXP_THEME_FOLDER/images/mimes/64/admin.png" height="64" width="64">
						</div>
					</div>
				]]></html>
			</infoPanel>		
		</component_config>
	</client_configs>
</driver>
